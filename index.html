<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <script src="./Js/aframe.min.js"></script>
        <script src="./Js/aframe-look-at-component.min.js"></script>
        <script src="./Js/aframe-ar-nft.js"></script>
        <script src="./Js/aframe-extras.loaders.min.js"></script>
            <style>
        body {
            padding: 0;
            margin: 0;
        }
        .dialog_outter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
                    z-index:100;
        }
        .dialog_wrapper {
            width: 400px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            box-sizing: border-box;
                    z-index:100;
        }

        .dialog_close_btn {
            position: absolute;
            right: 20px;
            top: 10px;
            cursor: pointer;
                    z-index:100;
        }

        .dialog_title {
            font-size: 18px;
            font-weight: 500;
            text-align: center;
                    z-index:100;
        }

        .dialog_content {
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
                    z-index:100;
        }

        .dialog_btn_group {
            display: flex;
            justify-content: flex-end;
                    z-index:100;
        }

        .btn_confirm {
            background-color: Blue;
            color: #fff;
            padding: 5px 10px;
            border: 1px solid blue;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }

        .btn_cancel {
            background-color: #fff;
            padding: 5px 10px;
            border: 1px solid #000;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }

        .form_item span {
            display: inline-block;
            width: 100px;
        }

        .form_item input{
            width: 200px;
            height: 25px;
            line-height: 25px;
            outline: none;
            border-radius: 5px;
        }

        .form_item {
            margin-bottom: 10px;
        }

        .form_item:last-child {
            margin-bottom: 0;
        }

        .overlap {
            z-index:100;
            width: 100%;
            height: 100%;
            display: none;
            position: absolute;
        }

          
        body,ul,li{margin: 0;padding: 0;font:12px/1.5 arial;/* 字体12像素 行高 1.5em 字体 Arial */ }
                ul,li{list-style:none}
                .wrap{width:100%; margin:20px auto;}
                .hide{display:none;}
                #hlist{height:40px; width:100%; border:1px solid #ccc;border-bottom: none}
                #hlist li{float:left; width:25%; line-height:40px; text-align:center; background:#d7d7d7; cursor:pointer}
                #hlist .selected{border-bottom:none; background:#fff;}
                #cdivs{width:100%; border:1px solid #ccc; border-top:none; text-align:center}
        #PipeInfo{
            z-index: 120;
            display: none;
        }


    </style>

    </head>

    <body style="margin: 0px; overflow: hidden;">
    <div class="dialog_outter" id="PipeInfo">
        <div class="dialog_wrapper">
          <div class="dialog_close_btn" onclick="closeDialog()">X</div>
          <div class="dialog_title">管道属性信息</div>
  
        <div class="wrap">
          <!-- The menu options -->
          <div id="hlist">
              <ul>
                  <li class="selected">管道属性信息</li>
                  <li>管道实时状态</li>
                  <li>管道历史信息</li>
                  <li>巡检记录信息</li>
              </ul>
          </div>
  
  
          
          <!-- The content box -->
          <div id="cdivs">
              <div id='part_1'>    
                <div class="dialog_content">
                  <div class="form_item"><span>SBID:</span><input type="text" id="name1" value=""></div>
                  <div class="form_item"><span>管道名称：</span><input type="text" id="name2" value=""></div>
                  <div class="form_item"><span>所属城区：</span><input type="text" id="name3" value=""></div>
                  <div class="form_item"><span>所属道路：</span><input type="text" id="name4" value=""></div>
                  <div class="form_item"><span>断面宽度(mm)：</span><input type="text" id="name5" value=""></div>
                  <div class="form_item"><span>断面高度(mm)：</span><input type="text" id="name6" value=""></div>
                  <div class="form_item"><span>电压等级：</span><input type="text" id="name7" value=""></div>
                  <div class="form_item"><span>电缆数量：</span><input type="text" id="name8" value=""></div>
                  <div class="form_item"><span>终点：</span><input type="text" id="name9" value=""></div>
                  <div class="form_item"><span>终点类型：</span><input type="text" id="name10" value=""></div>
                  <div class="form_item"><span>设施类型：</span><input type="text" id="name11" value=""></div>
                  <div class="form_item"><span>起点：</span><input type="text" id="name12" value=""></div>
                  <div class="form_item"><span>起点类型：</span><input type="text" id="name13" value=""></div>
                  <div class="form_item"><span>运行状态：</span><input type="text" id="name14" value=""></div>
                </div>    
              </div>
              <div class='hide' id='part_2'>
                <div class="dialog_content">
                  <div class="form_item"><span>管道名称：</span><input type="text" name="name" value="电力管道"></div>
                  <div class="form_item"><span>管道类型：</span><input type="text" name="name" value=""></div>
                </div>  
              </div>
              <div class='hide' id='part_3'>
                <div class="dialog_content">
                  <div class="form_item"><span>管道名称：</span><input type="text" name="name" value="雨水管道"></div>
                  <div class="form_item"><span>管道类型：</span><input type="text" name="name" value=""></div>
                </div>  
              </div>
              <div class='hide' id='part_4'>
                <div class="dialog_content">
                  <div class="form_item"><span>管道名称：</span><input type="text" name="name" value="油气管道"></div>
                  <div class="form_item"><span>管道类型：</span><input type="text" name="name" value=""></div>
                </div>  
              </div>
          </div>
      </div>
        </div>
      </div>
     
        <a-scene
            renderer="logarithmicDepthBuffer: true;"
            embedded
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            arjs="sourceType: webcam;debugUIEnabled: false;"
            emitevents="true"
            cursor="rayOrigin: mouse"
        >
            <a-assets>
                <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
            </a-assets>
            <a-entity id="tunnel_0" tunnel_0>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_1" tunnel_1>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_2" tunnel_2>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_3" tunnel_3>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_4" tunnel_4>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_5" tunnel_5>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_6" tunnel_6>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_7" tunnel_7>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_8" tunnel_8>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_9" tunnel_9>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_10" tunnel_10>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_11" tunnel_11>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_12" tunnel_12>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_13" tunnel_13>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_14" tunnel_14>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_15" tunnel_15>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_16" tunnel_16>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_17" tunnel_17>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_18" tunnel_18>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_19" tunnel_19>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_20" tunnel_20>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-camera
                fov="40"
                gps-camera="simulateLatitude: 30.265310;simulateLongitude: 120.120570;"
                rotation-reader
                look-controls-enabled="false"
                arjs-look-controls="smoothingFactor: 0.1"
            >
            </a-camera>
        </a-scene>
        <script>
        window.onload=function()
      {
            var hlist = document.getElementById('hlist').getElementsByTagName('li');
            var cdivs =document.getElementById('cdivs').children;
            for(var i=0;i<hlist.length;i++){
                hlist[i].index=i;
                hlist[i].onclick=function(){
                    for(var i=0;i<hlist.length;i++){
                        hlist[i].className='';
                        cdivs[i].className='hide';
                    }
                this.className='selected';
                cdivs[this.index].className='';
                }
            }
          }
            
  var JsonData = '';



  //实现传参的函数
  function ShowPipe(index)
  {
      console.log("可以在点击事件当中进行传参操作");
      console.log("正在查看管道"+{index});
      var Arr = JsonData;
      var pipeinfo = document.getElementById("PipeInfo");
      pipeinfo.style="display:block";


      if(Arr.length==0)
        return; 
    
      var data = Arr[index];
     
      

     
      console.log("JSON数据如下所示");
      console.log(data);

      console.log("JSON数据中的geometry如下所示");
      console.log(data.geometry);

      console.log("JSON数据中的properties如下所示");
      console.log(data.properties);
      
      var properties = data.properties;


      
      
      var elem = document.getElementById('name1');
      elem.value = properties['SBID'];

      var elem = document.getElementById('name2');
      elem.value = properties['名字'];

      var elem = document.getElementById('name3');
      elem.value = properties['所属城区'];

      var elem = document.getElementById('name4');
      elem.value = properties['所属道路'];

      var elem = document.getElementById('name5');
      elem.value = properties['断面宽度(mm)'];

      var elem = document.getElementById('name6');
      elem.value = properties['断面高度(mm)'];

      var elem = document.getElementById('name7');
      elem.value = properties['电压等级'];

      var elem = document.getElementById('name8');
      elem.value = properties['电缆数量'];

      var elem = document.getElementById('name9');
      elem.value = properties['终点'];

      var elem = document.getElementById('name10');
      elem.value = properties['终点类型'];

      var elem = document.getElementById('name11');
      elem.value = properties['设施类型'];

      var elem = document.getElementById('name12');
      elem.value = properties['起点'];

      var elem = document.getElementById('name13');
      elem.value = properties['起点类型'];

      var elem = document.getElementById('name14');
      elem.value = properties['运行状态'];

      
  }




  function closeDialog()
  {
    var elem = document.getElementById("PipeInfo");
    elem.style="display:None";
  }
    
       


            var positionList = [
                {
                    latitude: 30.26615,
                    longitude: 120.12042,
                },
                {
                    latitude: 30.2663,
                    longitude: 120.12085,
                },
                {
                    latitude: 30.26627,
                    longitude: 120.12115,
                },
                {
                    latitude: 30.26621,
                    longitude: 120.12146,
                },
                {
                    latitude: 30.26664,
                    longitude: 120.12057,
                },
                {
                    latitude: 30.26661,
                    longitude: 120.12111,
                },
                {
                    latitude: 30.26652,
                    longitude: 120.12167,
                },
                {
                    latitude: 30.26598,
                    longitude: 120.1221,
                },
                {
                    latitude: 30.26575,
                    longitude: 120.12223,
                },
                {
                    latitude: 30.26532,
                    longitude: 120.12178,
                },
                {
                    latitude: 30.26489,
                    longitude: 120.12149,
                },
                {
                    latitude: 30.26607,
                    longitude: 120.12168,
                },
                {
                    latitude: 30.2667,
                    longitude: 120.11995,
                },
                {
                    latitude: 30.26635,
                    longitude: 120.12259,
                },
                {
                    latitude: 30.26603,
                    longitude: 120.1228,
                },
                {
                    latitude: 30.26716,
                    longitude: 120.12088,
                },
                {
                    latitude: 30.26725,
                    longitude: 120.12035,
                },
                {
                    latitude: 30.26697,
                    longitude: 120.12159,
                },
                {
                    latitude: 30.26684,
                    longitude: 120.12215,
                },
            ];
            /*
            var map = [
                [9, 3],
                [1, 3],
                [1, 3],
                [2, 3],
                [2, 4],
                [5, 6],
                [2, 6],
                [3, 7],
                [10, 13],
                [5, 10],
                [3, 15],
                [10, 16],
                [11, 18],
                [9, 19],
                [5, 15],
                [6, 10],
                [6, 12],
                [1, 10],
                [2, 14],
                [3, 9],
                [4, 10],
            ];*/

            var map=[
                [0,1],
                [2,3],
                [4,5],
                [6,7],
                [8,9],
            ];

  var MArr = [];
  var IArr = [];
  function StoreCoord()
  {   
      
      var PData = JsonData;
      console.log("这里有输入的管线信息吗");
      console.log(JsonData);
      MArr = [];
      IArr = [];
      for(var i = 0;i<PData.length;i++)
      {
           var Geodata = PData[i]["geometry"];
           Geodata = Geodata["coordinates"];
           for(var j=0;j<Geodata.length;j++)
           {
              var latitude = Geodata[j][1];
              var longitude = Geodata[j][0];
              MArr.push({
                "latitude":latitude,
                "longitude":longitude,
              });
           }
          IArr.push([i*2,i*2+1]);
      }
      console.log("原始坐标数组如下所示");
      console.log(MArr);
      console.log(IArr);
      positionList = MArr;
      map = IArr;
      console.log("更改后的坐标数组如下所示");
      console.log(positionList);
      console.log("更改之后的坐标索引数组如下所示:");
      console.log(map);
      //appendEntity(positionList);
      //registerComponent(new Array(5).fill(0));
  }
  
  let curlng = 120.1194657;
  let curlat = 30.25918323;

  function GetPipeData(lat=30.25918323,lng=120.1194657)
  {
 
   let geourl = "https://artest.sucsoft.com.cn:9527/api/ar/server/pipeline?lon=" + String(lng) + " &lat=" + String(lat)
   fetch(geourl)
  .then((response) => response.text())
  .then((data) => {
    console.log("fetch函数获取的数据如下所示");

    console.log(data);
    JsonData = eval("("+data+")");
    StoreCoord();
    //删除所有的节点
    deleteAllEntity();
    appendEntity(positionList);
    registerComponent(new Array(21).fill(0));   
  });
  }


  GetPipeData(curlat,curlng);
   
  //删除已有节点
  function deleteAllEntity()
  {
    const scene = document.querySelector('a-scene');
    var t1 = document.getElementById('t1');
    var t2 = document.getElementById("t2");
    var t3 = document.getElementById("t3");
    var t4 = document.getElementById("t4");
    var t5 = document.getElementById("t5");
    if(scene.contains(t1))
    {
        scene.removeChild(t1);
    }
    if(scene.contains(t2))
    {
        scene.removeChild(t2);
    }
    if(scene.contains(t3))
    {
        scene.removeChild(t3);
    }
    if(scene.contians(t4))
    {
        scene.removeChild(t4);
    }
    if(scene.contains(t5))
    {
        scene.removeChild(t5);
    }
    
  }


  
  function appendEntity(arr) {
        const scene = document.querySelector('a-scene');
        arr.forEach((item, index) => {
            const entity = document.createElement('a-entity');
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('color', 'green');
            entity.setAttribute('gps-entity-place', {
                latitude: item.latitude,
                longitude: item.longitude,
            });
            entity.setAttribute('position', '0 -5 0');
            entity.setAttribute('id', 't' + (index + 1));
            entity.appendChild(sphere);
            scene.appendChild(entity);
        });
    }
  function registerComponent(arr) {
                arr.forEach((item, index) => {
                    AFRAME.registerComponent('tunnel_' + index, {
                        init: function () {
                            console.log("注册管道${index}");
                            const firstObj = document.getElementById('t' + map[index][0]);
                            const secondObj = document.getElementById('t' + map[index][1]);
                            const firstPos = new THREE.Vector3();
                            const secondPos = new THREE.Vector3();
                            const el = this.el;
                            const cylinder = this.el.querySelector('a-cylinder');
                            cylinder.addEventListener('click', function () {
                                cylinder.setAttribute('color', 'red');
                                console.log(`当前正在查看管道${index}信息`);
                                ShowPipe(index);
                            });
                            const idx = setInterval(() => {
                                firstPos.copy(firstObj.object3D.position);
                                secondPos.copy(secondObj.object3D.position);

                                const distance = firstPos.distanceTo(secondPos);
                                if (!distance) return;
                                console.log('anchors ready');
                                clearInterval(idx);

                                const middle = firstPos
                                    .multiplyScalar(-1)
                                    .add(secondPos)
                                    .multiplyScalar(1 / 2);

                                cylinder.setAttribute('height', distance);
                                el.object3D.lookAt(firstPos);
                                el.object3D.position.copy(middle).add(firstObj.object3D.position);
                            }, 500);
                        },
                    });
                });
            }
   
    var arrlen = map.length;
    //appendEntity 是把管道放入其中
    deleteAllEntity();//删除所有的组件
    appendEntity(positionList);
    registerComponent(new Array(21).fill(0));



        </script>
    </body>
</html>
