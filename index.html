<!DOCTYPE html>
<html>
    <head>
        <title>AR.js A-Frame Location-based</title>
        <script src="./Js/aframe.min.js"></script>
        <script type='text/javascript' src='./Js/ar-threex-location-only.js'></script>
        <script type='text/javascript' src='./Js/aframe-ar.js'></script>
        <script src="./Js/aframe-look-at-component.min.js"></script>
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            .dialog_outter {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 100;
            }
            .dialog_wrapper {
                width: 400px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid #f0f0f0;
                border-radius: 10px;
                padding: 10px;
                position: relative;
                box-sizing: border-box;
                z-index: 100;
            }

            .dialog_close_btn {
                position: absolute;
                right: 20px;
                top: 10px;
                cursor: pointer;
                z-index: 100;
            }

            .dialog_title {
                font-size: 18px;
                font-weight: 500;
                text-align: center;
                z-index: 100;
            }

            .dialog_content {
                padding: 20px;
                box-sizing: border-box;
                text-align: center;
                z-index: 100;
            }

            .dialog_btn_group {
                display: flex;
                justify-content: flex-end;
                z-index: 100;
            }

            .btn_confirm {
                background-color: Blue;
                color: #fff;
                padding: 5px 10px;
                border: 1px solid blue;
                border-radius: 4px;
                margin-right: 10px;
                cursor: pointer;
            }

            .btn_cancel {
                background-color: #fff;
                padding: 5px 10px;
                border: 1px solid #000;
                border-radius: 4px;
                margin-right: 10px;
                cursor: pointer;
            }

            .form_item span {
                display: inline-block;
                width: 100px;
            }

            .form_item input {
                width: 200px;
                height: 25px;
                line-height: 25px;
                outline: none;
                border-radius: 5px;
            }

            .form_item {
                margin-bottom: 10px;
            }

            .form_item:last-child {
                margin-bottom: 0;
            }

            .overlap {
                z-index: 100;
                width: 100%;
                height: 100%;
                display: none;
                position: absolute;
            }

            body,
            ul,
            li {
                margin: 0;
                padding: 0;
                font: 12px/1.5 arial; /* 字体12像素 行高 1.5em 字体 Arial */
            }
            ul,
            li {
                list-style: none;
            }
            .wrap {
                width: 100%;
                margin: 20px auto;
            }
            .hide {
                display: none;
            }
            #hlist {
                height: 40px;
                width: 100%;
                border: 1px solid #ccc;
                border-bottom: none;
            }
            #hlist li {
                float: left;
                width: 25%;
                line-height: 40px;
                text-align: center;
                background: #d7d7d7;
                cursor: pointer;
            }
            #hlist .selected {
                border-bottom: none;
                background: #fff;
            }
            #cdivs {
                width: 100%;
                border: 1px solid #ccc;
                border-top: none;
                text-align: center;
            }
            #PipeInfo {
                z-index: 120;
                display: none;
            }
        </style>
    </head>

    <body style="margin: 0px; overflow: hidden">
        <div class="dialog_outter" id="PipeInfo">
            <div class="dialog_wrapper">
                <div class="dialog_close_btn" onclick="closeDialog()">X</div>
                <div class="dialog_title">管道属性信息</div>

                <div class="wrap">
                    <!-- The menu options -->
                    <div id="hlist">
                        <ul>
                            <li class="selected">管道属性信息</li>
                            <li>管道实时状态</li>
                            <li>管道历史信息</li>
                            <li>巡检记录信息</li>
                        </ul>
                    </div>

                    <!-- The content box -->
                    <div id="cdivs">
                        <div id="part_1">
                            <div class="dialog_content">
                                <div class="form_item">
                                    <span>SBID:</span
                                    ><input type="text" id="name1" value="" />
                                </div>
                                <div class="form_item">
                                    <span>管道名称：</span
                                    ><input type="text" id="name2" value="" />
                                </div>
                                <div class="form_item">
                                    <span>所属城区：</span
                                    ><input type="text" id="name3" value="" />
                                </div>
                                <div class="form_item">
                                    <span>所属道路：</span
                                    ><input type="text" id="name4" value="" />
                                </div>
                                <div class="form_item">
                                    <span>断面宽度(mm)：</span
                                    ><input type="text" id="name5" value="" />
                                </div>
                                <div class="form_item">
                                    <span>断面高度(mm)：</span
                                    ><input type="text" id="name6" value="" />
                                </div>
                                <div class="form_item">
                                    <span>电压等级：</span
                                    ><input type="text" id="name7" value="" />
                                </div>
                                <div class="form_item">
                                    <span>电缆数量：</span
                                    ><input type="text" id="name8" value="" />
                                </div>
                                <div class="form_item">
                                    <span>终点：</span
                                    ><input type="text" id="name9" value="" />
                                </div>
                                <div class="form_item">
                                    <span>终点类型：</span
                                    ><input type="text" id="name10" value="" />
                                </div>
                                <div class="form_item">
                                    <span>设施类型：</span
                                    ><input type="text" id="name11" value="" />
                                </div>
                                <div class="form_item">
                                    <span>起点：</span
                                    ><input type="text" id="name12" value="" />
                                </div>
                                <div class="form_item">
                                    <span>起点类型：</span
                                    ><input type="text" id="name13" value="" />
                                </div>
                                <div class="form_item">
                                    <span>运行状态：</span
                                    ><input type="text" id="name14" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="hide" id="part_2">
                            <div class="dialog_content">
                                <div class="form_item">
                                    <span>管道名称：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                                <div class="form_item">
                                    <span>管道类型：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="hide" id="part_3">
                            <div class="dialog_content">
                                <div class="form_item">
                                    <span>管道名称：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                                <div class="form_item">
                                    <span>管道类型：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="hide" id="part_4">
                            <div class="dialog_content">
                                <div class="form_item">
                                    <span>管道名称：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                                <div class="form_item">
                                    <span>管道类型：</span
                                    ><input type="text" name="name" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <a-scene cursor='rayOrigin: mouse' raycaster='near: 0; far:100' vr-mode-ui='enabled: false'
        inspector="url: https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js" 
            arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true'>
            <a-camera 
                gps-new-camera='gpsMinDistance: 1' 
                look-controls-enabled='false' 
                arjs-device-orientation-controls='smoothingFactor: 0.1'>
            </a-camera>
        </a-scene>
        <script>
            let curlng = 120.058946; 
            let curlat =  30.309193;

            
            let yqlng = 120.120700;
            let yqlat = 30.265320;

            var pipeData = [], deviceData = [];

            window.onload = function () {
                const cameraEl = document.querySelector("[gps-new-camera]");

                //设置相机的位置
                //const data = cameraEl.components["gps-new-camera"].latLonToWorld(30.309193,120.058946);

                //重新设置一下相机的位置
                const data = cameraEl.components["gps-new-camera"].latLonToWorld(30.265320,120.120700);

                function test(longitude, latitude) {
                    const geodata = [
                        [longitude + 0.000001, latitude + 0.000001],
                        [longitude - 0.000001, latitude],
                    ]
                    const startCoords = geodata[0], endCoords = geodata[1];
                    const startPos = cameraEl.components["gps-new-camera"].latLonToWorld(startCoords[1],startCoords[0]);
                    const endPos = cameraEl.components["gps-new-camera"].latLonToWorld(endCoords[1],endCoords[0]);
                    const distance = Math.sqrt(Math.pow(endPos[0]-startPos[0], 2)+Math.pow(endPos[1]-startPos[1], 2));
                    const middle = [(startCoords[0]+endCoords[0])/2, (startCoords[1]+endCoords[1])/2];
                    
                    const sphere = document.createElement('a-cylinder');
                    sphere.setAttribute('id', 'sphere');
                    sphere.setAttribute('color', 'purple');
                    sphere.setAttribute('radius', 0.05);
                    sphere.setAttribute('height', 0.05);
                    sphere.setAttribute('gps-new-entity-place', {
                        longitude: startCoords[0],
                        latitude: startCoords[1]
                    });
                    document.querySelector("a-scene").appendChild(sphere);
                    const sphere2 = document.createElement('a-cylinder');
                    sphere2.setAttribute('id', 'sphere2');
                    sphere2.setAttribute('color', 'purple');
                    sphere2.setAttribute('radius', 0.05);
                    sphere2.setAttribute('height', 0.05);
                    sphere2.setAttribute('gps-new-entity-place', {
                        longitude: endCoords[0],
                        latitude: endCoords[1]
                    });
                    document.querySelector("a-scene").appendChild(sphere2);
                    const sphere3 = document.createElement('a-cylinder');
                    sphere3.setAttribute('id', 'sphere3');
                    sphere3.setAttribute('color', 'purple');
                    sphere3.setAttribute('radius', 0.05);
                    sphere3.setAttribute('height', 0.05);
                    // sphere3.setAttribute('position', "0 0.1 0");
                    sphere3.setAttribute('gps-new-entity-place', {
                        longitude: middle[0],
                        latitude: middle[1]
                    });
                    document.querySelector("a-scene").appendChild(sphere3);
                    
                    const entity = document.createElement("a-entity");
                    entity.setAttribute('gps-new-entity-place', {
                        longitude: middle[0],
                        latitude: middle[1]
                    });
                    const a = 180-Math.atan2(startPos[1]-endPos[1], startPos[0]-endPos[0])/Math.PI*180;
                    entity.setAttribute("rotation", {x: 0, y: a, z: 0});
                    // entity.object3D.lookAt(new THREE.Vector3(startPos[0],0,startPos[1]));
                    // entity.setAttribute("look-at", "#sphere");

                    const cylinder = document.createElement("a-cylinder");
                    cylinder.setAttribute("radius", 0.05);
                    cylinder.setAttribute("rotation", {x: 0, y: 0, z: -90});
                    cylinder.setAttribute("height", distance);
                    cylinder.setAttribute('material', { color: 'blue' } );
                    cylinder.setAttribute('position', "0 -5 0");

                    entity.appendChild(cylinder);
                    document.querySelector("a-scene").appendChild(entity);
                }

                let first = true;
                cameraEl.addEventListener("gps-camera-update-position", async(e) => {
                    const latitude = e.detail.position.latitude,
                        longitude = e.detail.position.longitude;
                    alert(longitude+"/"+latitude);
                    if(first) {
                        // getPipeData(latitude,longitude);
                        // getDeviceData(latitude,longitude);
                        test(longitude, latitude);
                        first = false;
                    }
                })

                if(navigator.geolocation) {
                    navigator.geolocation.watchPosition(function(e) {
                        // alert("geo:"+e.coords.longitude+"/"+e.coords.latitude)
                    },function(err){
                        // alert("geo error");
                    },{
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    })
                }

                // setTimeout(() => {
                //     if(first) {
                //         test(curlng, curlat);
                //         first = false;
                //     }
                // }, 2000);
                
                //获取附近设施
                //getPipeData(curlat,curlng);
                //getDeviceData(curlat,curlng);


                //获取玉泉附近设施
                getPipeData(yqlat,yqlng);
                getDeviceData(yqlat,yqlng);

                var hlist = document
                    .getElementById("hlist")
                    .getElementsByTagName("li");
                var cdivs = document.getElementById("cdivs").children;
                for (var i = 0; i < hlist.length; i++) {
                    hlist[i].index = i;
                    hlist[i].onclick = function () {
                        for (var i = 0; i < hlist.length; i++) {
                            hlist[i].className = "";
                            cdivs[i].className = "hide";
                        }
                        this.className = "selected";
                        cdivs[this.index].className = "";
                    };
                }
            };

            //实现传参的函数
            function ShowPipe(index) {
                console.log("可以在点击事件当中进行传参操作");
                console.log("正在查看管道" + { index });
                var Arr = pipeData;
                var pipeinfo = document.getElementById("PipeInfo");
                pipeinfo.style = "display:block";

                if (Arr.length == 0) return;
                var data = Arr[index];

                console.log("JSON数据如下所示");
                console.log(data);

                console.log("JSON数据中的geometry如下所示");
                console.log(data.geometry);

                console.log("JSON数据中的properties如下所示");
                console.log(data.properties);

                var properties = data.properties;

                var elem = document.getElementById("name1");
                elem.value = properties["SBID"];

                var elem = document.getElementById("name2");
                elem.value = properties["名字"];

                var elem = document.getElementById("name3");
                elem.value = properties["所属城区"];

                var elem = document.getElementById("name4");
                elem.value = properties["所属道路"];

                var elem = document.getElementById("name5");
                elem.value = properties["断面宽度(mm)"];

                var elem = document.getElementById("name6");
                elem.value = properties["断面高度(mm)"];

                var elem = document.getElementById("name7");
                elem.value = properties["电压等级"];

                var elem = document.getElementById("name8");
                elem.value = properties["电缆数量"];

                var elem = document.getElementById("name9");
                elem.value = properties["终点"];

                var elem = document.getElementById("name10");
                elem.value = properties["终点类型"];

                var elem = document.getElementById("name11");
                elem.value = properties["设施类型"];

                var elem = document.getElementById("name12");
                elem.value = properties["起点"];

                var elem = document.getElementById("name13");
                elem.value = properties["起点类型"];

                var elem = document.getElementById("name14");
                elem.value = properties["运行状态"];
            }

            function closeDialog() {
                var elem = document.getElementById("PipeInfo");
                elem.style = "display:None";
            }

            function getPipeData(lat = 30.25918323, lng = 120.1194657) {
                let geourl =
                    "https://artest.sucsoft.com.cn:9527/api/ar/server/pipeline?lon=" +
                    String(lng) +
                    " &lat=" +
                    String(lat);
                fetch(geourl)
                    .then((response) => response.json())
                    .then((data) => {
                        pipeData = data;
                        deletePipelineEntities();
                        appendPipeline(pipeData);
                    });
            }

            function getDeviceData(lat = 30.25918323, lng = 120.1194657) {
                let geourl =
                    "https://artest.sucsoft.com.cn:9527/api/ar/server/device?lon=" +
                    String(lng) +
                    " &lat=" +
                    String(lat);
                fetch(geourl)
                    .then((response) => response.json())
                    .then((data) => {
                        deviceData = data;
                        deleteDeviceEntities(deviceData);
                        appendDevice(deviceData);
                    });
            }

            function deletePipelineEntities() {
                const pipelines = document.querySelectorAll(".pipeline");
                pipelines.forEach((pipeline, index) => {
                    const cylinder = pipeline.querySelector("a-cylinder");
                    cylinder.removeEventListener("click", listenClick);
                    pipeline.destroy();
                    pipeline.parentNode.removeChild(pipeline);
                })
            }

            function deleteDeviceEntities() {
                const devices = document.querySelectorAll(".device");
                devices.forEach((device, index) => {
                    device.destroy();
                    device.parentNode.removeChild(device);
                })
            }

            function listenClick() {
                const pipelines = document.querySelectorAll(".pipeline");
                alert(pipelines.length);
                pipelines.forEach(function(pipeline) {
                    pipeline.setAttribute("color", "yellow");
                })
                this.setAttribute("color", "red");
                ShowPipe(this.getAttribute("index"));
            }

            function appendPipeline(arr) {
                const cameraEl = document.querySelector("[gps-new-camera]");
                const scene = document.querySelector("a-scene");
                arr.forEach((item, index) => {
                    const geodata = item["geometry"]["coordinates"];
                    const startCoords = geodata[0], endCoords = geodata[1];
                    const startPos = cameraEl.components["gps-new-camera"].latLonToWorld(startCoords[1],startCoords[0]);
                    const endPos = cameraEl.components["gps-new-camera"].latLonToWorld(endCoords[1],endCoords[0]);
                    const distance = Math.sqrt(Math.pow(endPos[0]-startPos[0], 2)+Math.pow(endPos[1]-startPos[1], 2));
                    const middle = [(startCoords[0]+endCoords[0])/2, (startCoords[1]+endCoords[1])/2];
                    const entity = document.createElement("a-entity");
                    const cylinder = document.createElement("a-cylinder");
                    cylinder.setAttribute("color", "yellow");
                    cylinder.setAttribute("radius", 1);
                    // cylinder.setAttribute("position", {x: 0, y: -5, z:0});
                    cylinder.setAttribute("rotation", {x: 0, y: 0, z: -90});
                    cylinder.setAttribute("index", index);
                    cylinder.setAttribute("height", distance);
                    cylinder.addEventListener("click", listenClick);

                    const text = document.createElement("a-text");
                    const textScale = 100;
                    text.setAttribute("look-at", "[gps-new-camera]");
                    text.setAttribute("scale", {
                        x: textScale,
                        y: textScale,
                        z: textScale
                    });
                    text.setAttribute("value", index);
                    text.setAttribute("align", "center");
                    text.setAttribute("color", "red");
                    // text.setAttribute("position", {x: 0, y: -5, z:0});

                    entity.setAttribute("gps-new-entity-place", {
                        longitude: middle[0],
                        latitude: middle[1],
                    });
                    // entity.object3D.lookAt(new THREE.Vector3(startPos[0],0,startPos[1]));
                    
                    const a = 180-Math.atan2(endPos[1]-startPos[1], endPos[0]-startPos[0])/Math.PI*180;
                    entity.setAttribute("rotation", {x: 0, y: a, z: 0});
                    entity.setAttribute("id", "tunnel_" + index);
                    entity.setAttribute("class", "pipeline");
                    entity.appendChild(cylinder);
                    entity.appendChild(text);
                    scene.appendChild(entity);
                });
            }

            function appendDevice(arr) {
                const cameraEl = document.querySelector("[gps-new-camera]");
                const scene = document.querySelector("a-scene");
                arr.forEach((item, index) => {
                    const coordinates = item["geometry"]["coordinates"];
                    const entity = document.createElement('a-entity');
                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('color', 'green');
                    sphere.setAttribute('radius', 1);
                    // sphere.setAttribute('position', '0 -5 0');
                    entity.setAttribute('gps-new-entity-place', {
                        latitude: coordinates[1],
                        longitude: coordinates[0]
                    });
                    entity.setAttribute('id', 'device' + (index + 1));
                    entity.setAttribute('class', 'device');
                    entity.appendChild(sphere);
                    scene.appendChild(entity);
                })
            }
        </script>
    </body>
</html>
