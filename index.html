<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <script src="./Js/aframe.min.js"></script>
        <script src="./Js/aframe-look-at-component.min.js"></script>
        <script src="./Js/aframe-ar-nft.js"></script>
        <script src="./Js/aframe-extras.loaders.min.js"></script>
        <script>
            function registerComponent(arr) {
                arr.forEach((item, index) => {
                    AFRAME.registerComponent('tunnel_' + index, {
                        init: function () {
                            const firstObj = document.getElementById('t' + map[index][0]);
                            const secondObj = document.getElementById('t' + map[index][1]);
                            const firstPos = new THREE.Vector3();
                            const secondPos = new THREE.Vector3();
                            const el = this.el;
                            const cylinder = this.el.querySelector('a-cylinder');
                            cylinder.addEventListener('click', function () {
                                console.log(`当前正在查看管道${index}信息`);
                                document.getElementById('#gpsinfo').innerHTML =
                                    '管道名称:管道' + index;
                                cylinder.setAttribute('color', 'red');
                            });
                            const idx = setInterval(() => {
                                firstPos.copy(firstObj.object3D.position);
                                secondPos.copy(secondObj.object3D.position);

                                const distance = firstPos.distanceTo(secondPos);
                                if (!distance) return;
                                console.log('anchors ready');
                                clearInterval(idx);

                                const middle = firstPos
                                    .multiplyScalar(-1)
                                    .add(secondPos)
                                    .multiplyScalar(1 / 2);

                                cylinder.setAttribute('height', distance);
                                el.object3D.lookAt(firstPos);
                                el.object3D.position.copy(middle).add(firstObj.object3D.position);
                            }, 500);
                        },
                    });
                });
            }

            registerComponent(new Array(21).fill(0));
        </script>
    </head>

    <body style="margin: 0; overflow: hidden">
        <div
            style="
                top: 10px;
                padding: '5px';
                text-align: center;
                z-index: 100;
                color: black;
                position: absolute;
            "
        >
            <p id="#gpsinfo" style="left: 5px" align="left">用于获取管道信息</p>
        </div>
        <a-scene
            renderer="logarithmicDepthBuffer: true;"
            embedded
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            arjs="sourceType: webcam;debugUIEnabled: false;"
            emitevents="true"
            cursor="rayOrigin: mouse"
        >
            <a-assets>
                <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
            </a-assets>
            <a-entity id="tunnel_0" tunnel_0>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_1" tunnel_1>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_2" tunnel_2>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_3" tunnel_3>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_4" tunnel_4>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_5" tunnel_5>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_6" tunnel_6>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_7" tunnel_7>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_8" tunnel_8>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_9" tunnel_9>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_10" tunnel_10>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_11" tunnel_11>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_12" tunnel_12>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_13" tunnel_13>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_14" tunnel_14>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_15" tunnel_15>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_16" tunnel_16>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_17" tunnel_17>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_18" tunnel_18>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_19" tunnel_19>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-entity id="tunnel_20" tunnel_20>
                <a-cylinder color="yellow" radius="0.25" rotation="0 90 -90"></a-cylinder>
            </a-entity>
            <a-camera
                fov="40"
                gps-camera="simulateLatitude: 30.265310;simulateLongitude: 120.120570;"
                rotation-reader
                look-controls-enabled="false"
                arjs-look-controls="smoothingFactor: 0.1"
            >
            </a-camera>
        </a-scene>
        <script>
            const positionList = [
                {
                    latitude: 30.26615,
                    longitude: 120.12042,
                },
                {
                    latitude: 30.2663,
                    longitude: 120.12085,
                },
                {
                    latitude: 30.26627,
                    longitude: 120.12115,
                },
                {
                    latitude: 30.26621,
                    longitude: 120.12146,
                },
                {
                    latitude: 30.26664,
                    longitude: 120.12057,
                },
                {
                    latitude: 30.26661,
                    longitude: 120.12111,
                },
                {
                    latitude: 30.26652,
                    longitude: 120.12167,
                },
                {
                    latitude: 30.26598,
                    longitude: 120.1221,
                },
                {
                    latitude: 30.26575,
                    longitude: 120.12223,
                },
                {
                    latitude: 30.26532,
                    longitude: 120.12178,
                },
                {
                    latitude: 30.26489,
                    longitude: 120.12149,
                },
                {
                    latitude: 30.26607,
                    longitude: 120.12168,
                },
                {
                    latitude: 30.2667,
                    longitude: 120.11995,
                },
                {
                    latitude: 30.26635,
                    longitude: 120.12259,
                },
                {
                    latitude: 30.26603,
                    longitude: 120.1228,
                },
                {
                    latitude: 30.26716,
                    longitude: 120.12088,
                },
                {
                    latitude: 30.26725,
                    longitude: 120.12035,
                },
                {
                    latitude: 30.26697,
                    longitude: 120.12159,
                },
                {
                    latitude: 30.26684,
                    longitude: 120.12215,
                },
            ];

            const map = [
                [9, 3],
                [1, 3],
                [1, 3],
                [2, 3],
                [2, 4],
                [5, 6],
                [2, 6],
                [3, 7],
                [10, 13],
                [5, 10],
                [3, 15],
                [10, 16],
                [11, 18],
                [9, 19],
                [5, 15],
                [6, 10],
                [6, 12],
                [1, 10],
                [2, 14],
                [3, 9],
                [4, 10],
            ];

            function appendEntity(arr) {
                const scene = document.querySelector('a-scene');
                arr.forEach((item, index) => {
                    const entity = document.createElement('a-entity');
                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('color', 'green');
                    entity.setAttribute('gps-entity-place', {
                        latitude: item.latitude,
                        longitude: item.longitude,
                    });
                    entity.setAttribute('position', '0 -5 0');
                    entity.setAttribute('id', 't' + (index + 1));
                    entity.appendChild(sphere);
                    scene.appendChild(entity);
                });
            }
            appendEntity(positionList);
        </script>
    </body>
</html>
